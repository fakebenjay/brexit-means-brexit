<!DOCTYPE html>
<html lang="en" dir="ltr">

  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- <script src="https://d3js.org/d3-format.v1.min.js"></script> -->
    <link rel="stylesheet" href="https://unpkg.com/tachyons/css/tachyons.min.css">
    <title>Brexit Means Brexit</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://use.typekit.net/odt8gpj.css">
    <link href="https://fonts.googleapis.com/css?family=Overpass" rel="stylesheet">
  </head>

  <body>
    <div id="map-div" class="vh-100 w-50 fl"></div>
    <div id="infobox" class="vh-100 w-50 fr">
      <h1 id="dist-name"></h1>
      <div id="pie" class="w-50 fl"></div>
      <div id="stats" class="w-50 fr"></div>
      <br></br>
      <div id="bars" style="clear: both;">
        <label for="#pct-bar-percap">EU spending, normalized per eligible voter (£1,013,925.17)</label>
        <div id="pct-bar-percap" style="clear: both;" class="pct-bar h3"></div>
        <br>
        <label for="#pct-bar-electorate">Eligible voters (46,475,882)</label>
        <div id="pct-bar-electorate" style="clear: both;" class="pct-bar h3"></div>
        <br>
        <label for="#pct-bar-total">Total EU spending (£100,321,726,921.54)</label>
        <div id="pct-bar-total" style="clear: both;" class="pct-bar h3"></div>
      </div>
    </div>
    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function() {
        var barDivs = document.querySelectorAll('.pct-bar')
        var barWidth = document.getElementById('bars').offsetWidth * 0.9

        for (let i = 0; i < barDivs.length; i++) {
          barDivs[i].style.width = `${barWidth}px`
          barDivs[i].style.offsetWidth = `${barWidth}px`
        }
      })

      function horizBar(d, propsObj) {
        Promise.all([d3.csv("pandas/output/spending.csv"), d, propsObj])
          .then(function(data) {
            var councilsAll = data[0].sort((a, b) => {
              return parseFloat(a.pct_remain) - parseFloat(b.pct_remain);
            })

            var that = data[1].properties
            var precedingPct = 0

            var scale = data[2].scale
            var divID = data[2].divID
            var keyNameSnake = data[2].keyNameSnake
            var keyNameCamel = data[2].keyNameCamel
            var svg = data[2].svg

            for (let i = 0; i < councilsAll.length; i++) {
              if (that.LAD13CD === councilsAll[i].area_code) {
                councilsAll[i].selected = true;
                that.precedingPct = precedingPct
              } else {
                councilsAll[i].selected = false;
              }
              councilsAll[i].precedingPct = precedingPct
              precedingPct += scale(councilsAll[i][keyNameSnake])
            }

            d3.select(divID).selectAll("div")
              .data(councilsAll)
              .enter()
              .append('div')
              .attr('class', (d) => {
                return `bar ${d.area_code}`
              })
              .style('height', `${hBar}px`)
              .style('width', (d) => {
                return `${scale(d[keyNameSnake])}%`
              })
              .style('background-color', (d) => {
                return barColorScale(d.pct_remain)
              });

            function widthKey(d, keyName, scale) {
              return `${scale(d.properties[keyName])}px`
            }

            svg.selectAll('rect')
              .data([that])
              .enter()
              .append('rect')
              .attr('x', (d) => {
                return `${d.precedingPct}px`
              })
              .attr('y', 0)
              .attr('width', widthKey(d, keyNameCamel, scale))
              .attr('height', `${hBar}px`)
              .style('fill', 'black')
              .style("stroke", 'black')
              .style("stroke-width", '1px');
          })
      }

      function drawPie(d, i) {
        var pie = d3.pie()
          .value(d => d)
          .sort(null);

        const arc = d3.arc()
          .innerRadius(0)
          .outerRadius(radius);

        const labelArc = d3.arc()
          .outerRadius(radius / 2)
          .innerRadius(radius / 2);

        function arcTween(a) {
          const i = d3.interpolate(this._current, a);
          this._current = i(1);
          return (t) => arc(i(t));
        }

        Promise.all([d])
          .then(function(data) {
            var properties = data[0].properties

            d3.selectAll("#map-div input")
              .on("click", update);

            function update(val = this.value) {
              //Update bars
              barPerCapSVG.selectAll('rect')
                .data([val])
                .transition()
                .attr("x", function(d) {
                  return `${barWidthScalePC(d.precedingPerCap)}px`
                })
                .attr('width', (d) => {
                  return `${barWidthScalePC(d.spendingPerVoter)}px`
                });

              barElectorateSVG.selectAll('rect')
                .data([val])
                .transition()
                .attr("x", function(d) {
                  return `${barWidthScaleElectorate(d.precedingElectorate)}px`
                })
                .attr('width', (d) => {
                  return `${barWidthScaleElectorate(d.electorate)}px`
                });

              barTotalSVG.selectAll('rect')
                .data([val])
                .transition()
                .attr("x", function(d) {
                  return `${barWidthScaleTotal(d.precedingProjEU)}px`
                })
                .attr('width', (d) => {
                  return `${barWidthScaleTotal(d.projEUContribution)}px`
                });

              // Join new data
              var results = [val.pctLeave, val.pctRemain]

              var piePath = pieSVG.selectAll("path")
                .data(pie(results));

              var labelArcs = pieSVG.selectAll('text')
                .data(pie(results));

              // Update existing arcs
              piePath.transition()
                .duration(200)
                .attrTween("d", arcTween);

              d3.selectAll("text")
                .transition()
                .duration(200)
                .tween("text", function(a) {
                  var that = d3.select(this);
                  var newVal = that.text().replace('%', '')
                  var oldVal = a.data
                  var iNum = d3.interpolateNumber(newVal, oldVal);
                  var format = d3.format(".4");
                  return function(t) {
                    that.text(`${format(iNum(t))}%`);
                  };
                })
                .attrTween("transform", function(a) {
                  // var c = arc.centroid(d);
                  // return "translate(" + c[0] + "," + c[1] + ")";
                  var i = d3.interpolate(this._current, a);
                  this._current = i(0);
                  return function(t) {
                    var radius = document.getElementById('pie').offsetWidth / 2
                    var centroidPt = labelArc.centroid(i(t))
                    return `translate(${centroidPt[0]},${centroidPt[1]})`;
                  }
                });

              // Enter new arcs
              piePath.enter()
                .append("path")
                .attr("fill", (d, i) => pieColor(i))
                .attr("d", arc)
                .attr("stroke", "white")
                .attr("stroke-width", "2px")
                .each(function(d) {
                  this._current = d;
                  // Store initial angels for transition: http://www.cagrimmett.com/til/2016/08/27/d3-transitions.html
                });

              labelArcs.enter()
                .append("text")
                .attr("class", "arc")
                .attr("transform", function(d) {
                  var radius = document.getElementById('pie').offsetWidth / 2
                  var centroidPt = labelArc.centroid(d)
                  return `translate(${centroidPt[0]},${centroidPt[1]})`;
                })
                .attr("text-anchor", "middle")
                .text(function(d) {
                  return `${d.data}%`;
                })
                .style('fill', 'white')
                .each(function(d) {
                  this._current = d;
                });
            }

            update(properties);
          })
      }

      var wBar = document.getElementById('pct-bar-percap').offsetWidth;
      var hBar = document.getElementById('pct-bar-percap').offsetHeight;

      //100321726921.54 total EU spending
      //1013925.169 per capita council sum
      //46475882 eligible voters

      var barPerCapSVG = d3.select("#pct-bar-percap")
        .append('svg')
        .attr('class', 'bar-svg')
        .attr('width', `100%`)
        .attr('height', '100%')
        .attr('viewBox', `0 0 ${Math.min(wBar, hBar)} ${Math.min(wBar, hBar)}`)
        .attr('preserveAspectRatio', 'xMinYMin');

      var barElectorateSVG = d3.select("#pct-bar-electorate")
        .append('svg')
        .attr('class', 'bar-svg')
        .attr('width', `100%`)
        .attr('height', '100%')
        .attr('viewBox', `0 0 ${Math.min(wBar, hBar)} ${Math.min(wBar, hBar)}`)
        .attr('preserveAspectRatio', 'xMinYMin');

      var barTotalSVG = d3.select("#pct-bar-total")
        .append('svg')
        .attr('class', 'bar-svg')
        .attr('width', `100%`)
        .attr('height', '100%')
        .attr('viewBox', `0 0 ${Math.min(wBar, hBar)} ${Math.min(wBar, hBar)}`)
        .attr('preserveAspectRatio', 'xMinYMin');

      //For some reason, I have to reduce the outer bound of the range to 90% of itself. Div crap?
      var barWidthScalePC = d3.scaleLinear()
        .domain([0, 1013925.169])
        .range([0, wBar * .9]);

      var barWidthScaleElectorate = d3.scaleLinear()
        .domain([0, 46475882])
        .range([0, wBar * .9]);

      var barWidthScaleTotal = d3.scaleLinear()
        .domain([0, 100321726921.54])
        .range([0, wBar * .9]);

      var barColorScale = d3.scaleQuantize()
        .domain([20, 80])
        .range(['#bd1d1e', '#d76150', '#eb9788', '#9d80d3', '#6644bb', '#0000a3']);

      var wPie = document.getElementById('pie').offsetWidth;
      var hPie = document.getElementById('pie').offsetWidth;
      var radius = Math.min(wPie, hPie) / 2;

      var pieColor = d3.scaleOrdinal(["#bd1d1e", "#0000a3"]);

      var pieSVG = d3.select("#pie")
        .append("svg")
        .attr("width", wPie)
        .attr("height", hPie)
        .append("g")
        .attr("transform", `translate(${Math.min(wPie, hPie) / 2},${Math.min(wPie, hPie) / 2})`);

      var w = document.querySelector('#map-div').offsetWidth;
      var h = document.querySelector('#map-div').offsetHeight * .99;

      var mapSVG = d3.select("#map-div")
        .append("svg")
        .attr("width", w)
        .attr("height", h)
        .append("g");

      var projection = d3.geoAlbers()
        .center([1.5, 55.2])
        .rotate([4.4, 0])
        .parallels([50, 50])
        .scale(3300)
        .translate([w / 2, h / 2]);

      var path = d3.geoPath()
        .projection(projection);

      var color = d3.scaleQuantize()
        .domain([20, 80])
        // .range(['#b40000', '#a20032', '#900064', '#640090', '#3200a2', '#0000b4']);
        // .range(['#a30000', '#940032', '#800064', '#640080', '#320091', '#0000a3']);
        .range(['#bd1d1e', '#b6182d', '#af143b', '#47008f', '#310099', '#0000a3']);
      // .range(['#a30000', '#a30032', '#a30064', '#6400a3', '#3200a3', '#0000a3']);
      // .range(['#a30000', '#a3002d', '#a3005a', '#5a00a3', '#2d00a3', '#0000a3']);
      // .range(['#a30000', '#9c001a', '#94002e', '#47008f', '#310099', '#0000a3']);
      // .range(['#bd1d1e', '#b6182d', '#af143b', '#5d0b95', '#4210a3', '#0a14b0']);
      // .range(['#bd1d1e', '#b41830', '#aa1241', '#650a90', '#4a0fa0', '#0a14b0']);
      // .range(['#bd1d1e', '#b11635', '#a50f4a', '#710886', '#530d9b', '#0a14b0']);
      // .range(['#ff0000', '#ee0040', '#dc0068', '#8f00cd', '#6500e8', '#0000ff']);

      var ptileOpacity = d3.scaleLinear()
        .domain([0, 100])
        .range([0.1, 1.0]);

      var spendingOpacity = d3.scaleLinear()
        .domain([5.179221, 3274.196])
        .range([0.1, 1.0]);

      Promise.all([
        d3.csv("pandas/output/spending.csv"),
        d3.json("local-area.json")
      ]).then(function(allData) {
        var stats = allData[0]
        var mapJSON = allData[1].features

        for (let i = 0; i < stats.length; i++) {
          let areaCode = stats[i].area_code
          let brexitConstituency = stats[i].brexit_constituency
          let region = stats[i].region
          let electorate = stats[i].electorate
          let remain = stats[i].remain
          let leave = stats[i].leave
          let pctRemain = parseFloat(stats[i].pct_remain).toFixed(2)
          let pctLeave = parseFloat(stats[i].pct_leave).toFixed(2)
          let projEUContribution = parseFloat(stats[i].project_eu_contribution_gbp).toFixed(2)
          let spendingPerVoter = parseFloat(stats[i].spending_per_voter).toFixed(2)
          let percentile = parseFloat(stats[i].spending_percentile)
          let precedingPerCap = parseFloat(stats[i].preceding_per_cap)
          let precedingProjEU = parseFloat(stats[i].preceding_proj_eu)
          let precedingElectorate = parseFloat(stats[i].preceding_electorate)

          for (let j = 0; j < mapJSON.length; j++) {
            let areaID = mapJSON[j].properties.LAD13CD

            if (areaID === areaCode) {
              //Copy the data value into the JSON
              mapJSON[j].properties.LAD13NM = brexitConstituency
              mapJSON[j].properties.region = region
              mapJSON[j].properties.electorate = electorate
              mapJSON[j].properties.remain = remain
              mapJSON[j].properties.leave = leave
              mapJSON[j].properties.pctRemain = pctRemain
              mapJSON[j].properties.pctLeave = pctLeave
              mapJSON[j].properties.projEUContribution = projEUContribution
              mapJSON[j].properties.spendingPerVoter = spendingPerVoter
              mapJSON[j].properties.percentile = percentile
              mapJSON[j].properties.precedingPerCap = precedingPerCap
              mapJSON[j].properties.precedingProjEU = precedingProjEU
              mapJSON[j].properties.precedingElectorate = precedingElectorate

              //Stop looking through the JSON
              break;
            }
          }
        }

        mapSVG.selectAll("path")
          .data(mapJSON)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("id", (d) => {
            return d.properties.LAD13CD
          })
          .attr("name", (d) => {
            return d.properties.LAD13NM
          })
          .style("fill", (d) => {
            var value = d.properties.pctRemain;
            return color(value)
          })
          .attr('fill-opacity', d => spendingOpacity(d.properties.spendingPerVoter))
          .on("click", (d, i) => {
            header = document.querySelector('#dist-name')
            header.innerText = d.properties.LAD13NM

            if (d.properties.region === "Scotland") {
              header.className = 'scotland'
            } else if (d.properties.region === "Wales") {
              header.className = 'wales'
            } else if (d.properties.region === "Northern Ireland") {
              header.className = 'northern-ireland'
            } else {
              header.className = 'england'
            }
            drawPie(d, i)
            horizBar(d, {
              'scale': barWidthScalePC,
              'divID': "#pct-bar-percap",
              'keyNameSnake': "spending_per_voter",
              'keyNameCamel': "spendingPerVoter",
              'svg': barPerCapSVG
            })
            horizBar(d, {
              'scale': barWidthScaleElectorate,
              'divID': "#pct-bar-electorate",
              'keyNameSnake': "electorate",
              'keyNameCamel': "electorate",
              'svg': barElectorateSVG
            })
            horizBar(d, {
              'scale': barWidthScaleTotal,
              'divID': "#pct-bar-total",
              'keyNameSnake': "project_eu_contribution_gbp",
              'keyNameCamel': "projEUContribution",
              'svg': barTotalSVG
            })
          });
      });
    </script>
  </body>

</html>